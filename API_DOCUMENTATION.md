# Unsaycret API æ–‡æª”

æœ¬é …ç›®æä¾›èªéŸ³è™•ç†èˆ‡èªè€…ç®¡ç†çš„APIæœå‹™ã€‚

## ğŸ¯ API ç«¯é»ç¸½è¦½

### èªéŸ³è™•ç†API
- `POST /transcribe` - èªéŸ³è½‰éŒ„èˆ‡èªè€…è­˜åˆ¥

### èªè€…ç®¡ç†API
- `GET /speakers` - åˆ—å‡ºæ‰€æœ‰èªè€…
- `GET /speaker/{speaker_id}` - æŸ¥è©¢ç‰¹å®šèªè€…è³‡è¨Š
- `POST /speaker/rename` - èªè€…æ”¹å
- `POST /speaker/transfer` - è²ç´‹è½‰ç§»
- `DELETE /speaker/{speaker_id}` - åˆªé™¤èªè€…åŠå…¶è²ç´‹


## ğŸ“‹ APIè©³ç´°èªªæ˜

### 1. èªéŸ³è½‰éŒ„åŠŸèƒ½

**ç«¯é»**: `POST /transcribe`

**åŠŸèƒ½**: ä¸Šå‚³éŸ³è¨Šæª”æ¡ˆé€²è¡ŒèªéŸ³åˆ†é›¢ã€èªè€…è­˜åˆ¥èˆ‡èªéŸ³è½‰éŒ„

**è«‹æ±‚æ ¼å¼**: `multipart/form-data`
- **file** (required): éŸ³è¨Šæª”æ¡ˆ (æ”¯æ´ `.wav`, `.mp3`, `.m4a` ç­‰æ ¼å¼)

**å›æ‡‰æ ¼å¼**:
```json
{
  "segments": [
    {
      "speaker_id": "81d60ed8-3c8b-43b8-808d-2dd4409ca814",
      "speaker_name": "ç‹å°æ˜",
      "start_time": 0.0,
      "end_time": 3.5,
      "text": "ä½ å¥½ï¼Œä»Šå¤©å¤©æ°£å¾ˆå¥½",
      "confidence": 0.95
    },
    {
      "speaker_id": "a372ca19-8531-4f3d-bee2-a7580989acf6",
      "speaker_name": "æå°è¯",
      "start_time": 3.6,
      "end_time": 7.2,
      "text": "æ˜¯çš„ï¼Œå¾ˆé©åˆå‡ºå»èµ°èµ°",
      "confidence": 0.92
    }
  ],
  "pretty": "ç‹å°æ˜: ä½ å¥½ï¼Œä»Šå¤©å¤©æ°£å¾ˆå¥½\næå°è¯: æ˜¯çš„ï¼Œå¾ˆé©åˆå‡ºå»èµ°èµ°"
}
```

**ä½¿ç”¨ç¯„ä¾‹**:
```bash
# ä½¿ç”¨ curl ä¸Šå‚³éŸ³è¨Šæª”æ¡ˆ
curl -X POST "http://localhost:18000/transcribe" \
     -H "accept: application/json" \
     -H "Content-Type: multipart/form-data" \
     -F "file=@your_audio_file.wav"
```

### 2. èªè€…åˆ—è¡¨æŸ¥è©¢

**ç«¯é»**: `GET /speakers`

**åŠŸèƒ½**: ç²å–æ‰€æœ‰èªè€…çš„å®Œæ•´è³‡è¨Šåˆ—è¡¨

**è«‹æ±‚åƒæ•¸**: ç„¡

**å›æ‡‰æ ¼å¼**:
```json
[
  {
    "speaker_id": "81d60ed8-3c8b-43b8-808d-2dd4409ca814",
    "name": "ç‹å°æ˜",
    "first_audio_id": "9a123520-db14-4b98-b0f5-c27470632946",
    "created_at": "2025-06-29T22:00:22.752980+08:00",
    "updated_at": "2025-06-29T22:51:08.300915+08:00",
    "voiceprint_ids": [
      "9a123520-db14-4b98-b0f5-c27470632946",
      "f9d94903-6748-4cef-b89e-7f2d359e764b",
      "9d8334c2-262d-4029-9e89-80a9908f34eb"
    ]
  },
  {
    "speaker_id": "a372ca19-8531-4f3d-bee2-a7580989acf6",
    "name": "æå°è¯",
    "first_audio_id": "908cd3c8-0bf1-4041-8f85-88f40c2adc31",
    "created_at": "2025-06-29T22:00:22.203953+08:00",
    "updated_at": "2025-06-29T22:00:14.715988+08:00",
    "voiceprint_ids": [
      "908cd3c8-0bf1-4041-8f85-88f40c2adc31",
      "f45a57cb-5dc6-4799-a3eb-2fac92ed6aba"
    ]
  }
]
```

**æ¬„ä½èªªæ˜**:
- `speaker_id`: èªè€…çš„å”¯ä¸€è­˜åˆ¥ç¢¼ (UUID)
- `name`: èªè€…åç¨±
- `first_audio_id`: ç¬¬ä¸€å€‹è²ç´‹IDï¼ˆç”¨æ–¼åƒè€ƒï¼‰
- `created_at`: èªè€…å‰µå»ºæ™‚é–“ (ISO 8601æ ¼å¼)
- `updated_at`: æœ€å¾Œæ´»å‹•æ™‚é–“ (ISO 8601æ ¼å¼)
- `voiceprint_ids`: è©²èªè€…çš„æ‰€æœ‰è²ç´‹IDåˆ—è¡¨

**ä½¿ç”¨ç¯„ä¾‹**:
```bash
curl -X GET "http://localhost:18000/speakers" \
     -H "accept: application/json"
```

### 3. å–®ä¸€èªè€…è³‡è¨ŠæŸ¥è©¢

**ç«¯é»**: `GET /speaker/{speaker_id}`

**åŠŸèƒ½**: ç²å–æŒ‡å®šèªè€…çš„è©³ç´°è³‡è¨Š

**è·¯å¾‘åƒæ•¸**:
- `speaker_id` (required): èªè€…çš„UUID

**å›æ‡‰æ ¼å¼**:
```json
{
  "speaker_id": "81d60ed8-3c8b-43b8-808d-2dd4409ca814",
  "speaker_name": "ç‹å°æ˜",
  "created_time": "2025-06-29T22:00:22.752980+08:00",
  "last_active_time": "2025-06-29T22:51:08.300915+08:00",
  "voiceprint_count": 3
}
```

**ä½¿ç”¨ç¯„ä¾‹**:
```bash
curl -X GET "http://localhost:18000/speaker/81d60ed8-3c8b-43b8-808d-2dd4409ca814" \
     -H "accept: application/json"
```

### 4. èªè€…æ”¹ååŠŸèƒ½

**ç«¯é»**: `POST /speaker/rename`

**åŠŸèƒ½**: æ›´æ”¹æŒ‡å®šèªè€…çš„åç¨±

**è«‹æ±‚æ ¼å¼**:
```json
{
  "speaker_id": "èªè€…çš„UUID",
  "current_name": "ç•¶å‰åç¨±",
  "new_name": "æ–°åç¨±"
}
```

**å›æ‡‰æ ¼å¼**:
```json
{
  "success": true,
  "message": "æˆåŠŸå°‡èªè€… 'èˆŠåç¨±' æ›´åç‚º 'æ–°åç¨±'",
  "data": {
    "speaker_id": "èªè€…çš„UUID",
    "old_name": "èˆŠåç¨±",
    "new_name": "æ–°åç¨±"
  }
}
```

**ä½¿ç”¨ç¯„ä¾‹**:
```bash
curl -X POST "http://localhost:18000/speaker/rename" \
     -H "Content-Type: application/json" \
     -d '{
       "speaker_id": "123e4567-e89b-12d3-a456-426614174000",
       "current_name": "ç‹å°æ˜",
       "new_name": "ç‹å¤§æ˜"
     }'
```

### 5. è²ç´‹è½‰ç§»åŠŸèƒ½

**ç«¯é»**: `POST /speaker/transfer`

**åŠŸèƒ½**: å°‡ä¸€å€‹èªè€…çš„æ‰€æœ‰è²ç´‹è½‰ç§»åˆ°å¦ä¸€å€‹èªè€…ï¼Œä¸¦åˆªé™¤ä¾†æºèªè€…

**è«‹æ±‚æ ¼å¼**:
```json
{
  "source_speaker_id": "ä¾†æºèªè€…çš„UUID",
  "source_speaker_name": "ä¾†æºèªè€…åç¨±",
  "target_speaker_id": "ç›®æ¨™èªè€…çš„UUID",
  "target_speaker_name": "ç›®æ¨™èªè€…åç¨±"
}
```

**å›æ‡‰æ ¼å¼**:
```json
{
  "success": true,
  "message": "æˆåŠŸå°‡èªè€… 'ä¾†æºåç¨±' çš„æ‰€æœ‰è²ç´‹è½‰ç§»åˆ° 'ç›®æ¨™åç¨±' ä¸¦åˆªé™¤ä¾†æºèªè€…",
  "data": {
    "source_speaker_id": "ä¾†æºèªè€…UUID",
    "source_speaker_name": "ä¾†æºèªè€…åç¨±",
    "target_speaker_id": "ç›®æ¨™èªè€…UUID",
    "target_speaker_name": "ç›®æ¨™èªè€…åç¨±"
  }
}
```

**ä½¿ç”¨ç¯„ä¾‹**:
```bash
curl -X POST "http://localhost:18000/speaker/transfer" \
     -H "Content-Type: application/json" \
     -d '{
       "source_speaker_id": "123e4567-e89b-12d3-a456-426614174000",
       "source_speaker_name": "éŒ¯èª¤è­˜åˆ¥çš„èªè€…",
       "target_speaker_id": "987fcdeb-51d3-12a4-b567-426614174111",
       "target_speaker_name": "æ­£ç¢ºçš„èªè€…"
     }'
```

### 6. èªè€…åˆªé™¤åŠŸèƒ½

**ç«¯é»**: `DELETE /speaker/{speaker_id}`

**åŠŸèƒ½**: åˆªé™¤æŒ‡å®šèªè€…åŠå…¶æ‰€æœ‰é—œè¯çš„è²ç´‹è³‡æ–™

**è·¯å¾‘åƒæ•¸**:
- `speaker_id` (required): èªè€…çš„UUID

**å›æ‡‰æ ¼å¼**:
```json
{
  "success": true,
  "message": "æˆåŠŸåˆªé™¤èªè€… 'ç‹å°æ˜' åŠå…¶ 3 å€‹è²ç´‹",
  "data": {
    "speaker_id": "81d60ed8-3c8b-43b8-808d-2dd4409ca814",
    "speaker_name": "ç‹å°æ˜",
    "deleted_voiceprint_count": 3
  }
}
```

**ä½¿ç”¨ç¯„ä¾‹**:
```bash
curl -X DELETE "http://localhost:18000/speaker/81d60ed8-3c8b-43b8-808d-2dd4409ca814" \
     -H "accept: application/json"
```

**âš ï¸ é‡è¦æé†’**:
- æ­¤æ“ä½œç‚º**ä¸å¯é€†**æ“ä½œ
- æœƒåŒæ™‚åˆªé™¤èªè€…æœ¬èº«å’Œå…¶æ‰€æœ‰è²ç´‹è³‡æ–™
- è«‹è¬¹æ…ä½¿ç”¨æ­¤åŠŸèƒ½

### 7. èªéŸ³èº«ä»½é©—è­‰

**ç«¯é»**: `POST /speaker/verify`

**åŠŸèƒ½**: æŸ¥è©¢è²éŸ³æ˜¯å¦ç‚ºè³‡æ–™åº«å·²æœ‰çš„èªè€… (ç´”è®€å–æ“ä½œ - ä¸Šå‚³éŸ³æª”é©—è­‰èªè€…èº«ä»½ï¼Œä¸æœƒå°è³‡æ–™åº«é€²è¡Œä»»ä½•ä¿®æ”¹æˆ–æ–°å¢æ“ä½œ)

**è«‹æ±‚æ ¼å¼**: `multipart/form-data`
- **file** (required): è¦é©—è­‰çš„éŸ³æª” (æ”¯æ´ `.wav` æ ¼å¼)
- **threshold** (optional): æ¯”å°é–¾å€¼ï¼Œè·é›¢å°æ–¼æ­¤å€¼æ‰èªç‚ºæ˜¯åŒ¹é…åˆ°èªè€…ï¼Œé è¨­ 0.4 (ç¯„åœ 0.0-1.0)
- **max_results** (optional): è¿”å›æœ€ç›¸ä¼¼çš„çµæœæ•¸é‡ï¼Œé è¨­ 3 (ç¯„åœ 1-10)

**å›æ‡‰æ ¼å¼**:
```json
{
  "success": true,
  "message": "èªéŸ³é©—è­‰å®Œæˆ",
  "is_known_speaker": true,
  "best_match": {
    "voiceprint_id": "9a123520-db14-4b98-b0f5-c27470632946",
    "speaker_name": "ç‹å°æ˜",
    "distance": 0.23,
    "is_match": true
  },
  "all_candidates": [
    {
      "voiceprint_id": "9a123520-db14-4b98-b0f5-c27470632946",
      "speaker_name": "ç‹å°æ˜",
      "distance": 0.23,
      "update_count": 5,
      "is_match": true
    },
    {
      "voiceprint_id": "f9d94903-6748-4cef-b89e-7f2d359e764b",
      "speaker_name": "æå°è¯",
      "distance": 0.68,
      "update_count": 3,
      "is_match": false
    }
  ],
  "threshold": 0.4,
  "total_candidates": 2
}
```

**å›æ‡‰æ¬„ä½èªªæ˜**:
- `is_known_speaker`: æ˜¯å¦ç‚ºå·²çŸ¥èªè€…ï¼ˆåŸºæ–¼æ¯”å°é–¾å€¼ï¼‰
- `best_match`: æœ€ä½³åŒ¹é…çµæœï¼ŒåŒ…å«èªè€…è³‡è¨Šå’Œç›¸ä¼¼åº¦
- `all_candidates`: æ‰€æœ‰å€™é¸çµæœï¼ŒæŒ‰ç›¸ä¼¼åº¦æ’åº
- `distance`: é¤˜å¼¦è·é›¢ï¼ˆè¶Šå°è¶Šç›¸ä¼¼ï¼Œ0.0-1.0ï¼‰
- `threshold`: æ¯”å°é–¾å€¼ï¼Œè·é›¢å°æ–¼æ­¤å€¼æ‰èªç‚ºæ˜¯åŒ¹é…
- `is_match`: è©²å€™é¸æ˜¯å¦è¶…éæ¯”å°é–¾å€¼
- `update_count`: è©²è²ç´‹çš„æ›´æ–°æ¬¡æ•¸
- `total_candidates`: å€™é¸çµæœç¸½æ•¸

**ä½¿ç”¨ç¯„ä¾‹**:
```bash
# åŸºæœ¬é©—è­‰
curl -X POST "http://localhost:18000/speaker/verify" \
     -H "accept: application/json" \
     -H "Content-Type: multipart/form-data" \
     -F "file=@voice_to_verify.wav"

# è‡ªè¨‚é–¾å€¼å’Œçµæœæ•¸é‡
curl -X POST "http://localhost:18000/speaker/verify" \
     -H "accept: application/json" \
     -H "Content-Type: multipart/form-data" \
     -F "file=@voice_to_verify.wav" \
     -F "threshold=0.3" \
     -F "max_results=5"
```

**ç‰¹é»èªªæ˜**:
- âœ… **ç´”è®€å–æ“ä½œ**: ä¸æœƒä¿®æ”¹ã€æ–°å¢æˆ–åˆªé™¤ä»»ä½•è³‡æ–™åº«å…§å®¹
- âœ… **å³æ™‚é©—è­‰**: å¿«é€Ÿåˆ¤æ–·éŸ³æª”ä¸­çš„èªè€…èº«ä»½
- âœ… **å¤šæ ¼å¼æ”¯æ´**: æ”¯æ´å¸¸è¦‹çš„éŸ³æª”æ ¼å¼
- âœ… **éˆæ´»é–¾å€¼**: å¯èª¿æ•´æ¯”å°åš´æ ¼ç¨‹åº¦
- âœ… **è©³ç´°çµæœ**: æä¾›å®Œæ•´çš„æ¯”å°ä¿¡æ¯å’Œå€™é¸åˆ—è¡¨


## âš ï¸ éŒ¯èª¤è™•ç†

æ‰€æœ‰APIéƒ½åŒ…å«å®Œæ•´çš„éŒ¯èª¤è™•ç†æ©Ÿåˆ¶ï¼š

### HTTPç‹€æ…‹ç¢¼
- **200 OK**: è«‹æ±‚æˆåŠŸ
- **400 Bad Request**: åƒæ•¸éŒ¯èª¤æˆ–é©—è­‰å¤±æ•—
- **404 Not Found**: æ‰¾ä¸åˆ°æŒ‡å®šçš„èªè€…
- **500 Internal Server Error**: ä¼ºæœå™¨å…§éƒ¨éŒ¯èª¤

### éŒ¯èª¤å›æ‡‰æ ¼å¼
```json
{
  "detail": "éŒ¯èª¤æè¿°è¨Šæ¯"
}
```

### å¸¸è¦‹éŒ¯èª¤æƒ…æ³
1. **èªè€…ä¸å­˜åœ¨**: ç•¶æä¾›çš„ `speaker_id` ç„¡æ³•åœ¨è³‡æ–™åº«ä¸­æ‰¾åˆ°
2. **åç¨±ä¸åŒ¹é…**: æ”¹åæ™‚æä¾›çš„ `current_name` èˆ‡è³‡æ–™åº«ä¸­çš„åç¨±ä¸ç¬¦
3. **åƒæ•¸é©—è­‰å¤±æ•—**: å¿…è¦åƒæ•¸ç‚ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¢º
4. **ç›¸åŒIDæ“ä½œ**: è²ç´‹è½‰ç§»æ™‚ä¾†æºå’Œç›®æ¨™èªè€…ç‚ºåŒä¸€äºº

## ğŸš€ éƒ¨ç½²èˆ‡å•Ÿå‹•

### 1. ç’°å¢ƒæº–å‚™
```bash
# å®‰è£ä¾è³´å¥—ä»¶
pip install -r requirements.txt

# å•Ÿå‹•Weaviateè³‡æ–™åº«
docker-compose up -d
```

### 2. å•Ÿå‹•APIæœå‹™
```bash
# æ–¹æ³•ä¸€ï¼šä½¿ç”¨ main.py
python main.py

# æ–¹æ³•äºŒï¼šä½¿ç”¨ uvicorn å‘½ä»¤
uvicorn services.api:app --reload

# æ–¹æ³•ä¸‰ï¼šæŒ‡å®šä¸»æ©Ÿå’Œç«¯å£
uvicorn services.api:app --host 0.0.0.0 --port 18000 --reload
```

### 3. è¨ªå•APIæ–‡æª”
- **Swagger UI**: http://localhost:18000/docs
- **ReDoc**: http://localhost:18000/redoc


## ğŸ” å®‰å…¨æ³¨æ„äº‹é …

1. **èº«ä»½é©—è­‰**: 
   - èªè€…æ”¹åå’Œè²ç´‹è½‰ç§»æœƒé©—è­‰æä¾›çš„ç•¶å‰åç¨±æ˜¯å¦èˆ‡è³‡æ–™åº«åŒ¹é…
   - UUIDé©—è­‰ç¢ºä¿èªè€…å­˜åœ¨æ–¼è³‡æ–™åº«ä¸­

2. **æ“ä½œå®‰å…¨**:
   - è²ç´‹è½‰ç§»æ“ä½œæœƒåˆªé™¤ä¾†æºèªè€…ï¼Œ**ç„¡æ³•è‡ªå‹•æ’¤éŠ·**
   - èªè€…åˆªé™¤æ“ä½œæœƒåŒæ™‚åˆªé™¤æ‰€æœ‰é—œè¯çš„è²ç´‹è³‡æ–™ï¼Œ**ä¸å¯é€†**
   - å»ºè­°åœ¨åŸ·è¡Œé‡è¦æ“ä½œå‰å…ˆä½¿ç”¨æŸ¥è©¢APIç¢ºèªè³‡æ–™

3. **è³‡æ–™å®Œæ•´æ€§**:
   - æ‰€æœ‰ä¿®æ”¹æ“ä½œéƒ½æœ‰åŸå­æ€§ä¿è­‰
   - æ“ä½œå¤±æ•—æ™‚ä¸æœƒç•™ä¸‹ä¸ä¸€è‡´çš„è³‡æ–™ç‹€æ…‹

4. **æ—¥èªŒç›£æ§**:
   - æ‰€æœ‰æ“ä½œéƒ½æœƒè¨˜éŒ„åœ¨ç³»çµ±æ—¥èªŒä¸­
   - åŒ…å«æ“ä½œæ™‚é–“ã€åƒæ•¸å’Œçµæœï¼Œä¾¿æ–¼å¯©è¨ˆå’Œé™¤éŒ¯

## ğŸ§ª æ¸¬è©¦èˆ‡é™¤éŒ¯

### åŠŸèƒ½æ¸¬è©¦
```bash
# åŸ·è¡Œèªè€…APIæ¸¬è©¦è…³æœ¬
python examples/test_speaker_api.py
```

### APIæ¸¬è©¦å·¥å…·
- **Swagger UI**: http://localhost:18000/docs
- **ReDoc**: http://localhost:18000/redoc

### é™¤éŒ¯å»ºè­°
1. æª¢æŸ¥æ—¥èªŒæª”æ¡ˆ `system_output.log` ç²å–è©³ç´°éŒ¯èª¤è³‡è¨Š
2. ç¢ºèª Weaviate è³‡æ–™åº«é€£æ¥æ­£å¸¸
3. é©—è­‰è«‹æ±‚åƒæ•¸æ ¼å¼æ˜¯å¦æ­£ç¢º

## â“ å¸¸è¦‹å•é¡Œ

**Q: åˆ—è¡¨APIè¿”å›çš„ `first_audio_id` æœ‰ä»€éº¼ç”¨é€”ï¼Ÿ**
A: `first_audio_id` æ˜¯è©²èªè€…çš„ç¬¬ä¸€å€‹è²ç´‹IDï¼Œå¯ç”¨æ–¼åƒè€ƒæˆ–å¿«é€Ÿè¨ªå•è©²èªè€…çš„è²ç´‹æ¨£æœ¬ã€‚

**Q: è²ç´‹è½‰ç§»æœƒå½±éŸ¿èªéŸ³è­˜åˆ¥çš„æº–ç¢ºæ€§å—ï¼Ÿ**
A: è½‰ç§»æ“ä½œåªæ˜¯å°‡è²ç´‹è³‡æ–™é‡æ–°é—œè¯ï¼Œä¸æœƒæ”¹è®Šè²ç´‹å‘é‡æœ¬èº«ï¼Œå› æ­¤ä¸æœƒå½±éŸ¿è­˜åˆ¥æº–ç¢ºæ€§ã€‚

**Q: å¦‚ä½•æ¢å¾©å·²åˆªé™¤çš„èªè€…ï¼Ÿ**
A: èªè€…åˆªé™¤æ“ä½œä¸å¯é€†ã€‚å»ºè­°åœ¨åŸ·è¡Œåˆªé™¤å‰ä½¿ç”¨ `GET /speakers` å‚™ä»½é‡è¦è³‡æ–™ã€‚

**Q: APIæ”¯æŒæ‰¹æ¬¡æ“ä½œå—ï¼Ÿ**
A: ç›®å‰ç‰ˆæœ¬ä¸æ”¯æŒæ‰¹æ¬¡æ“ä½œï¼Œæ¯æ¬¡è«‹æ±‚åªèƒ½è™•ç†ä¸€å€‹èªè€…ã€‚å¦‚éœ€æ‰¹æ¬¡æ“ä½œï¼Œè«‹å¤šæ¬¡èª¿ç”¨APIã€‚

**Q: è½‰ç§»æ“ä½œå¤±æ•—å¾Œå¦‚ä½•è™•ç†ï¼Ÿ**
A: å¦‚æœè½‰ç§»å¤±æ•—ï¼ŒåŸå§‹è³‡æ–™æœƒä¿æŒä¸è®Šã€‚æª¢æŸ¥éŒ¯èª¤è¨Šæ¯ä¸¦ç¢ºèªåƒæ•¸æ­£ç¢ºå¾Œé‡æ–°å˜—è©¦ã€‚
